<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<title>Painel - Fam√≠lia Oliveira (Organizadora)</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body{font-family:Arial,Helvetica,sans-serif;margin:0;background:linear-gradient(135deg,#fff,#f7ead0);color:#333}
.header{background:rgba(255,215,0,0.95);padding:18px;text-align:center;font-weight:700;color:#5a4a00}
.container{max-width:900px;margin:20px auto;background:rgba(255,255,255,0.95);padding:20px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.12)}
textarea,input,button{font-size:15px}
textarea,input{width:100%;padding:10px;margin:8px 0;border-radius:6px;border:1px solid #ccc;box-sizing:border-box}
button{background:gold;border:none;padding:10px 14px;border-radius:8px;cursor:pointer;font-weight:700}
.resultline{padding:8px;border-bottom:1px solid #eee}
.resultline b{color:#5a4a00}
.row{display:flex;gap:10px}
.small{font-size:13px;color:#666}
</style>
</head>
<body>
<div class="header">Painel da Organizadora ‚Äî Fam√≠lia Oliveira</div>
<div class="container">
  <h3>üîê Acesso com senha mestra</h3>
  <p class="small">Cole aqui os blobs (mensagens criptografadas) recebidos dos participantes ‚Äî um por linha ‚Äî e clique em "Descriptografar". A senha mestra √© a que voc√™ escolheu.</p>
  <label>Senha mestra</label>
  <input id="masterPwd" type="password" placeholder="Senha mestra (ex.: Oliveira2025)">

  <label>Colar blobs (um por linha)</label>
  <textarea id="blobs" rows="6" placeholder="Cole aqui os textos criptografados recebidos..."></textarea>
  <div style="margin-top:8px" class="row">
    <button id="decryptBtn">Descriptografar</button>
    <button id="clearBtn" style="background:#eee;color:#333">Limpar</button>
  </div>

  <h3 style="margin-top:18px">Resultados</h3>
  <div id="resultsArea"></div>

  <h3 style="margin-top:12px">Itens restantes</h3>
  <div id="remainingArea"></div>

  <div style="margin-top:14px" class="small">Observa√ß√£o: nada √© enviado a servidores. Tudo acontece no navegador. Mantenha a senha mestra em seguran√ßa.</div>
</div>

<script>
// same item list (will be updated after decrypting)
let initialItems = [
"Arroz (Janta 31/12)","Arroz (Almo√ßo 01/01)","Feij√£o tropeiro (Janta 31/12)",
"Feijoada (Almo√ßo 01/01)","Vinagrete e salada (Almo√ßo 01/01)","Vinagrete e salada (Janta 31/12)",
"Escondidinho √† gosto - 15 po√ß√µes (Janta 31/12)","Salpic√£o √† gosto - 15 por√ß√µes (Janta 31/12)",
"Lasanha √† gosto - 15 por√ß√µes (Almo√ßo 01/01)","Strogonoff - 15 por√ß√µes (Almo√ßo 01/01)",
"Pudim - 15 por√ß√µes (p√≥s janta 31/12)","Bombom na travessa - 15 por√ß√µes (p√≥s janta 31/12)",
"Pav√™ - 15 por√ß√µes (p√≥s almo√ßo 01/01)","Mousse de maracuj√°- 15 por√ß√µes (p√≥s almo√ßo 01/01)",
"P√£o (contribui√ß√£o em dinheiro 20,00)","1 Caf√© p√≥ (servido pt manh√£)","1 Caf√© p√≥ (servido pt tarde)",
"1L Leite (servido parte manh√£)","1L Leite (servido parte tarde)","1 Margarina 250g","1k Queijo",
"15un Chimango (caf√© da manh√£)","15un P√£o de queijo (caf√© da tarde)","1 Bolo simples de padaria (caf√© da manh√£)",
"1 Bolo simples de padaria (caf√© da tarde)","1L Suco (caf√© da manh√£)","1L Suco (caf√© da tarde)",
"Chocolate em p√≥","Bolo de tapioca - 15 por√ß√µes (caf√© da manh√£)","Cuscuz- 10 por√ß√µes (caf√© da manh√£)",
"Salada de frutas - 15 por√ß√µes (caf√© da tarde)","A - Champanhe/ espumante sem √°lcool","B - Champanhe/ espumante sem √°lcool"
];

// Crypto helpers (same as participant page)
async function deriveKey(password, salt) {
  let enc = new TextEncoder();
  let keyMaterial = await window.crypto.subtle.importKey("raw", enc.encode(password), {"name":"PBKDF2"}, false, ["deriveKey"]);
  return window.crypto.subtle.deriveKey({"name":"PBKDF2","salt":salt,"iterations":250000,"hash":"SHA-256"}, keyMaterial, {"name":"AES-GCM","length":256}, false, ["encrypt","decrypt"]);
}

async function decryptText(password, b64) {
  const combined = Uint8Array.from(atob(b64), c => c.charCodeAt(0));
  const salt = combined.slice(0,16);
  const iv = combined.slice(16,28);
  const ct = combined.slice(28);
  const key = await deriveKey(password, salt);
  const pt = await window.crypto.subtle.decrypt({"name":"AES-GCM","iv":iv}, key, ct);
  return new TextDecoder().decode(pt);
}

document.getElementById('decryptBtn').addEventListener('click', async ()=>{
  const master = document.getElementById('masterPwd').value.trim();
  const raw = document.getElementById('blobs').value.trim();
  if(!master){alert('Digite a senha mestra.');return;}
  if(!raw){alert('Cole ao menos um blob.');return;}
  const lines = raw.split(/[\r\n]+/).map(l=>l.trim()).filter(Boolean);
  const results = [];
  for(const line of lines){
    try{
      const dec = await decryptText(master, line);
      // parse JSON
      const obj = JSON.parse(dec);
      results.push(obj);
    }catch(e){
      alert('Erro ao descriptografar um dos blobs. Verifique a senha mestra e os blobs inseridos.'); 
      console.error(e);
      return;
    }
  }
  // show results and compute remaining items
  const area = document.getElementById('resultsArea');
  area.innerHTML = '';
  const taken = [];
  results.forEach(r=>{
    const div = document.createElement('div');
    div.className = 'resultline';
    div.innerHTML = '<b>' + escapeHtml(r.nome) + '</b> ‚Äî ' + escapeHtml(r.item) + ' <span style="color:#666">(' + new Date(r.ts).toLocaleString() + ')</span>';
    area.appendChild(div);
    taken.push(r.item);
  });
  // compute remaining
  const remaining = initialItems.filter(i=>!taken.includes(i));
  const remArea = document.getElementById('remainingArea');
  remArea.innerHTML = '';
  if(remaining.length===0){
    remArea.textContent = 'Nenhum item restante.';
  }else{
    remaining.forEach(it=>{
      const d = document.createElement('div');
      d.className='resultline';
      d.textContent = it;
      remArea.appendChild(d);
    });
  }
});

document.getElementById('clearBtn').addEventListener('click', ()=>{
  document.getElementById('blobs').value='';
  document.getElementById('masterPwd').value='';
  document.getElementById('resultsArea').innerHTML='';
  document.getElementById('remainingArea').innerHTML='';
});

function escapeHtml(s){ return s.replace(/[&<>"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m]; });}
</script>
</body>
</html>
